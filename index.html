<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>News Impact Dashboard</title>
  <!-- Plotly for charting -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f8fafc;
      margin: 0;
      padding: 20px;
      color: #1f2937;
    }
    h1, h2 {
      text-align: center;
    }
    .dashboard-container {
      max-width: 1100px;
      margin: 0 auto;
      background-color: #ffffff;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.1);
    }
    .controls {
      display: flex;
      align-items: center;
      gap: 15px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    .controls label {
      font-weight: 600;
    }
    .controls input[type="range"] {
      width: 220px;
    }
    #chart {
      width: 100%;
      height: 500px;
    }
    #newsList {
      margin-top: 30px;
    }
    .news-item {
      border-left: 4px solid #2563eb;
      background-color: #f9fafb;
      padding: 16px 20px;
      margin-bottom: 20px;
      border-radius: 8px;
    }
    .news-item h3 {
      margin: 0;
      font-size: 1.1rem;
      color: #1e40af;
    }
    .news-item p {
      margin: 5px 0;
      font-size: 0.95rem;
      color: #374151;
    }
    .news-item a {
      color: #2563eb;
      font-weight: 500;
      text-decoration: none;
    }
    .news-item a:hover {
      text-decoration: underline;
    }
    .footer {
      text-align: center;
      margin-top: 40px;
      font-size: 0.85rem;
      color: #6b7280;
    }
    /* Simple color coding for sentiment */
    span.negative {
      color: #dc2626; /* red */
      font-weight: 600;
    }
    span.positive {
      color: #16a34a; /* green */
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <h1>Stock & News Impact Dashboard</h1>
    <p style="text-align:center; max-width: 800px; margin: 0 auto;">
      Observe how recent news headlines might correlate with stock price movements. Use the slider to filter out lower-impact news events and focus on the stories most likely to move the market.
    </p>

    <!-- Controls -->
    <div class="controls">
      <label for="impactSlider">Impact Threshold:</label>
      <input type="range" id="impactSlider" min="0" max="1" step="0.05" value="0.50" oninput="updateThreshold(this.value)">
      <span id="impactValue">0.50</span>
    </div>

    <!-- Chart -->
    <div id="chart">Loading chart...</div>

    <!-- News Section -->
    <h2>Relevant News</h2>
    <div id="newsList">Loading news...</div>
    <div class="footer">
      &copy; 2025 - Team 8
    </div>
  </div>

  <script>
    let stockData = [];       // Will hold array of { date, close }
    let newsData = [];        // Will hold array of { date, impact, sentiment, ... }
    let currentThreshold = 0.50;  // Default threshold

    document.addEventListener("DOMContentLoaded", async () => {
      await loadData();
      renderChartAndNews();
    });

    // Fetch data from local JSON
    async function loadData() {
      try {
        // Load stock data
        const stockRes = await fetch("stock.json");
        const stockJson = await stockRes.json();
        // We expect { symbol: "...", history: [ {date: "yyyy-mm-dd", close: number}, ... ] }
        stockData = stockJson.history || [];

        // Load news data
        const newsRes = await fetch("news.json");
        const newsJson = await newsRes.json();
        // We expect { articles: [ { title, date, impact, sentiment, description, url }, ... ] }
        newsData = newsJson.articles || [];
      } catch (error) {
        console.error("Error loading JSON data:", error);
      }
    }

    function renderChartAndNews() {
      // 1) Filter news by the current threshold
      const filteredNews = newsData.filter(item => item.impact >= currentThreshold);

      // 2) Sort stock data by date (if needed) and prepare for Plotly
      const sortedStock = [...stockData].sort((a, b) => new Date(a.date) - new Date(b.date));

      // 3) Build the Plotly trace for the stock price
      const traceStock = {
        x: sortedStock.map(d => d.date),
        y: sortedStock.map(d => d.close),
        mode: 'lines+markers',
        name: 'Stock Price',
        line: { color: '#2563eb' },
        type: 'scatter'
      };

      // 4) Create markers for news (color-coded by sentiment)
      const newsMarkers = filteredNews.map(article => {
        // If "date" in news is "2025-07-15"
        // We'll make an annotation/marker at that date, with y=null to produce a vertical marker
        let markerColor = '#16a34a'; // green
        if (article.sentiment === 'negative') {
          markerColor = '#dc2626';   // red
        }
        return {
          x: [article.date],
          y: [null], // We'll let Plotly place it on the chart with null => scattered marker
          mode: 'markers',
          name: 'News',
          text: [`${article.title}<br>${article.date}`],
          marker: { size: 10, color: markerColor, symbol: 'diamond' },
          type: 'scatter'
        };
      });

      // 5) Plot the chart
      const layout = {
        title: `Stock Price with News Event Overlays`,
        xaxis: { title: 'Date', type: 'date' },
        yaxis: { title: 'Price (USD)' },
        legend: { orientation: "h", y: -0.2 }
      };
      Plotly.newPlot('chart', [traceStock, ...newsMarkers], layout);

      // 6) Render the news list
      renderNewsList(filteredNews);
    }

    function renderNewsList(newsArray) {
      const newsContainer = document.getElementById("newsList");
      newsContainer.innerHTML = "";

      if (newsArray.length === 0) {
        newsContainer.innerHTML = "<p>No news events found above the current impact threshold.</p>";
        return;
      }

      // Sort news by date (descending) to show latest first, or ascending as you wish
      const sortedNews = [...newsArray].sort((a, b) => new Date(a.date) - new Date(b.date));

      sortedNews.forEach(article => {
        const div = document.createElement("div");
        div.className = "news-item";
        
        const sentimentClass = article.sentiment === 'negative' ? 'negative' : 'positive';
        const dateStr = new Date(article.date).toLocaleDateString();

        div.innerHTML = `
          <h3>
            <span class="${sentimentClass}">${article.sentiment}</span>
            &middot; ${article.title}
          </h3>
          <p><strong>${dateStr}</strong> | Impact: <strong>${(article.impact).toFixed(2)}</strong></p>
          <p>${article.description || ""}</p>
          <a href="${article.url}" target="_blank">Read full article</a>
        `;
        newsContainer.appendChild(div);
      });
    }

    // Slider input handler
    function updateThreshold(val) {
      currentThreshold = parseFloat(val);
      document.getElementById("impactValue").textContent = val;
      renderChartAndNews();
    }
  </script>
</body>
</html>
